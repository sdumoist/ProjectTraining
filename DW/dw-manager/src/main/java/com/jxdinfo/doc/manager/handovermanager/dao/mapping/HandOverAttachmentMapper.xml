<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jxdinfo.doc.manager.handovermanager.dao.HandOverAttachmentMapper" >

    <select id="getAttachmentList" resultType="FsFolderView">
     SELECT
	* from (
		(
			SELECT
				di.doc_id fileId,
				di.title fileName,
				di.doc_type fileType,
				1 orderName,
				di.create_time createTime,
				su.USER_NAME createUserName,
				su.USER_ID createUserId,
				ifnull(dho.hand_over_state, '') state,
				ss.ORGAN_ALIAS deptName,
  dhoa.hand_over_id folderId
			FROM
				doc_info di
			LEFT JOIN sys_users su ON su.user_id = di.user_id
			LEFT JOIN sys_stru ss ON ss.stru_id = su.DEPARTMENT_ID
			LEFT JOIN doc_hand_over_attachment dhoa ON dhoa.resource_id = di.doc_id
			AND dhoa.resource_type = 0
			LEFT JOIN doc_hand_over dho ON dho.hand_over_id = dhoa.hand_over_id
		)
			UNION ALL
				(
					SELECT
						di.component_id fileId,
						di.component_name fileName,
						'component' fileType,
						2 orderName,
						di.create_time createTime,
						su.USER_NAME createUserName,
						su.USER_ID createUserId,
						ifnull(dho.hand_over_state, '') state,
						ss.ORGAN_ALIAS deptName,
  dhoa.hand_over_id folderId
					FROM
						component_apply di
					LEFT JOIN sys_users su ON su.user_id = di.user_id
					LEFT JOIN sys_stru ss ON ss.stru_id = su.DEPARTMENT_ID
					LEFT JOIN doc_hand_over_attachment dhoa ON dhoa.resource_id = di.component_id
					AND dhoa.resource_type = 1
					LEFT JOIN doc_hand_over dho ON dho.hand_over_id = dhoa.hand_over_id

				)
			UNION ALL
				(
					SELECT
						di.folder_id fileId,
						di.folder_name fileName,
						'folder' fileType,
						4 orderName,
						di.create_time createTime,
						su.USER_NAME createUserName,
						su.USER_ID createUserId,
						ifnull(dho.hand_over_state, '') state,
						ss.ORGAN_ALIAS deptName,
           dhoa.hand_over_id folderId
					FROM
						fs_folder di
					LEFT JOIN sys_users su ON su.user_id = di.create_user_id
					LEFT JOIN sys_stru ss ON ss.stru_id = su.DEPARTMENT_ID
					LEFT JOIN doc_hand_over_attachment dhoa ON dhoa.resource_id = di.folder_id
					AND dhoa.resource_type = 2
					LEFT JOIN doc_hand_over dho ON dho.hand_over_id = dhoa.hand_over_id

				)
		) T where 1=1  and state!='' and   folderId = #{id}
        <if test="name != ''and name != null">
            AND fileName = #{name}
        </if>
        and fileName !='我的文件夹'
        order by  orderName desc , createTime desc
        LIMIT #{beginNum}, #{limit}
    </select>
    <select id="getAttachmentCount" resultType="int">
        SELECT
         count(*) from (
        (
        SELECT
        di.doc_id fileId,
        di.title fileName,
        di.doc_type fileType,
        1 orderName,
        di.create_time createTime,
        su.USER_NAME createUserName,
        su.USER_ID createUserId,
        ifnull(dho.hand_over_state, '') state,
        ss.ORGAN_ALIAS deptName,
        dhoa.hand_over_id folderId
        FROM
        doc_info di
        LEFT JOIN sys_users su ON su.user_id = di.user_id
        LEFT JOIN sys_stru ss ON ss.stru_id = su.DEPARTMENT_ID
        LEFT JOIN doc_hand_over_attachment dhoa ON dhoa.resource_id = di.doc_id
        AND dhoa.resource_type = 0
        LEFT JOIN doc_hand_over dho ON dho.hand_over_id = dhoa.hand_over_id
        )
        UNION ALL
        (
        SELECT
        di.component_id fileId,
        di.component_name fileName,
        'component' fileType,
        2 orderName,
        di.create_time createTime,
        su.USER_NAME createUserName,
        su.USER_ID createUserId,
        ifnull(dho.hand_over_state, '') state,
        ss.ORGAN_ALIAS deptName,
        dhoa.hand_over_id folderId
        FROM
        component_apply di
        LEFT JOIN sys_users su ON su.user_id = di.user_id
        LEFT JOIN sys_stru ss ON ss.stru_id = su.DEPARTMENT_ID
        LEFT JOIN doc_hand_over_attachment dhoa ON dhoa.resource_id = di.component_id
        AND dhoa.resource_type = 1
        LEFT JOIN doc_hand_over dho ON dho.hand_over_id = dhoa.hand_over_id

        )
        UNION ALL
        (
        SELECT
        di.folder_id fileId,
        di.folder_name fileName,
        'folder' fileType,
        4 orderName,
        di.create_time createTime,
        su.USER_NAME createUserName,
        su.USER_ID createUserId,
        ifnull(dho.hand_over_state, '') state,
        ss.ORGAN_ALIAS deptName,
        dhoa.hand_over_id folderId
        FROM
        fs_folder di
        LEFT JOIN sys_users su ON su.user_id = di.create_user_id
        LEFT JOIN sys_stru ss ON ss.stru_id = su.DEPARTMENT_ID
        LEFT JOIN doc_hand_over_attachment dhoa ON dhoa.resource_id = di.folder_id
        AND dhoa.resource_type = 2
        LEFT JOIN doc_hand_over dho ON dho.hand_over_id = dhoa.hand_over_id

        )
        ) T where 1=1 and state =0 and state!='' and   folderId = #{id}
        <if test="name != ''and name != null">
            AND fileName = #{name}
        </if>
        and fileName !='我的文件夹'
    </select>
</mapper>